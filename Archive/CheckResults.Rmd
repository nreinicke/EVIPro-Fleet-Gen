---
title: "Spot Check SEIN Results"
author: "Jerome Carman"
date: "5/8/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 10)
knitr::opts_chunk$set(comment = NA)
```

# Check SEIN Results

 Completed model runs from the SEIN project need to be gut checked with an emphasis on making sure Sedan and SUV are different

# Libraries

```{r}
library(data.table) # data structure
library(ggplot2) 
library(scales) # additional graphing
library(future.apply)
library(doParallel)
```

# Check for NAs in All Data Files
If data file contents are returned, than no NAs are found. If NAs are found, an error is printed.
```{r}
plan(multisession, workers=7)
file_paths <- dir("../../output/EVIPro-Lite/20200506/", pattern = ".csv", full.names = T)
future_lapply(file_paths, function(i) {
	# Load data file
	d_output <- fread(i)
	
	# Check for NAs in data file
	tryCatch(na.fail(d_output),error = function(x) print(paste0("\nNAs found in ",i)))
})
```

# Load One Temp Data Set to Analyze and Graph

The -10C data file is used here.

```{r}
d_output <- fread(file_paths[2]) # -10C file
```

## Look At Fleet Characteristic Options

Confirm all fleet characteristic options are present

```{r}
# show unique valid values
sapply(d_output[, !c('kw','time_of_day'), with = F], unique)
```

## Create lazy function to subset results and graph load
  
*lazy* refers to the fact that this is a wrapper for a workflow rather than a more generalizable function.

```{r}
graphFunc <- function(d, f_size, dvmt, class_option) {
	sub_check <- d[fleet_size == f_size & # largest fleet size
	mean_dvmt == dvmt &
	pev_dist == "BEV" &
	pref_dist == "Home100" &
	home_access_dist == "HA100" &
	home_power_dist == "Equal" &
	work_power_dist == "MostL2" &
	class_dist == class_option,
	.(sum_kw = sum(kw)),
	by = c("dest_type",
	"dest_chg_level",
	"time_of_day",
	"day_of_week")]
	
	# round values for ave kw to make graph more readable
	# sub_check$sum_kw <- round(sub_check$sum_kw, digits = 2)
	
	# Show kw by destination, charge type, and vehicle class throughout the day
	plotResult <- ggplot(data = sub_check, aes(x = time_of_day, y = sum_kw)) +
	geom_area(aes(fill = dest_chg_level)) +
	facet_grid(day_of_week ~ dest_type) +
	scale_y_continuous(label = comma) +
	labs(
	fill = "Destination Charge Level",
	y = "Sum kw",
	x = "Time of Day",
	subtitle = paste("Fleet Size of ", f_size, "and mean daily VMT of", dvmt)
	) +
	theme(legend.position = "bottom", text = element_text(size = 16))
	
	return(plotResult)
}
```

## Output graphs showing different dvmts and fleet sizes

Highest daily vehicle miles traveled for sedans

```{r}
graphFunc(d_output, f_size = 10000, dvmt = 45, class_option = "Sedan")
```

Highest daily vehicle miles traveled for SUVs

```{r}
graphFunc(d_output, f_size = 10000, dvmt = 45, class_option = "SUV")
```

Lowest daily vehicle miles traveled for sedans

```{r}
graphFunc(d_output, f_size = 10000, dvmt = 25, class_option = "Sedan")
```

Lowest daily vehicle miles traveled for SUVs

```{r}
graphFunc(d_output, f_size = 10000, dvmt = 25, class_option = "SUV")
```

The lowest fleet size produces more variability and much less overall kw used

```{r}
graphFunc(d_output, f_size = 1000, dvmt = 25, class_option = "Sedan")
```

Highest possible output based on fleet size and dvmt

```{r}
graphFunc(d_output, f_size = 50000, dvmt = 45, class_option = "Sedan")
```

No NAs are found in any of the data sets. Overall the trends expected in fleet size, dvmt, and the difference between Sedans and SUVs have held. SUVs use more energy than sedans with all other things being equal. Energy usage also scales appropriately as the fleet size and miles traveled change.
