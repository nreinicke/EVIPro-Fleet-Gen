---
title: "EVI-Pro Lite Load Profiles"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 7, fig.height = 5)
options(warning.length = 2000L)
```

Load libraries and functions. The openEVI() function sources all functions except randVector(), so all we need are these two.

```{r}
library(future.apply)
library(ggplot2)
library(data.table)
library(magrittr)
library(foreach)
library(doFuture)

source("functions/func_openEVI.R")
source("functions/func_randVector.R")

theme_set(theme_bw() + theme(strip.background = element_blank()))
```

Specify user variable options stored in a vector. Where there are different permutations of user variable sets, store as a list of vectors. future.apply will parallel iterate through the different permutations. 

```{r}
#REMOVE THIS WHEN READY. KEEP FOR TROUBLE SHOOTING AT THE MOMENT
#mean_vmt <- 40 #mean daily vehicle miles traveled

#temp_list <- c(0, 10, 15, 20) #temp in deg C. Options are -20, -15, -10, -5, 0, 5, 10, 15, 20, 25, 30, 35, 40

# weights_list <- list("rural" = list(weights = NULL,
#                                     temp = 15,
#                                     mean_vmt = 50,
#                                     loc_class = "rural"),
#                      "urban" = list(weights = NULL,
#                                     temp = 25,
#                                     mean_vmt = 30,
#                                     loc_class = "urban"))
```

```{r}
temp_vec <- c("-20C"
              # "-10C",
              # "0C",
              # "10C",
              # "20C",
              # "30C",
              # "40C"
              ) #celsius
pev_type_vec <- list("BEV25" = c(0, 0, .30, .70) # PHEV20, PHEV50,BEV100, BEV250; all BEV
                     #"BEV50" = c(.10, .15, .25, .50), # BEV Dominant
                     #"BEV75" = c(.25, .50, .10, .15), # PHEV Dominant
                     #"BEV100" = c(.15, .35, .15, .35) # PHEV/BEV Equal share
                 )
work_power_vec <- list("L2100" = c(0,1))
loc_class_vec <- list("urban")
fleet_size_vec <- list(500
                    #1000,
                    #2500,
                    #5000
                    #10000,
                    #20000,
                    #50000
                    ) #count of total number of PEVs
mean_dvmt_vec <- c(#15,
                   #20,
                   25
                   #30,
                   #40,
                   #50
                   ) #average daily miles traveled per vehicle
pref_vec <- list("Home80" = c(0.8,0.2)
                 #"Home50" = c(0.5,0.5)
                 )
home_power_vec <- list("HA100_L225" = c(0.75,0.25,0)#, #100% access to home power, 75% of those L1
                       # "HA100_L275" = c(0.25,0.75,0), #100% access to home power, 75% of those L2
                       # "HA100_L2100" = c(0,1,0), #100% access to home power, all of those L2
                       # "HA75_L225" = c(0.5625,0.1875,0.25), #75% access to home power, 75% of those L1
                       # "HA75_L275" = c(0.1875,0.5625,0.25), #75% access to home power, 75% of those L2
                       # "HA75_L2100" = c(0,0.75,0.25), #75% access to home power, all of those L2
                       # "HA50_L225" = c(0.375,0.125,0.5), #50% access to home power, 75% of those L1
                       # "HA50_L275" = c(0.125,0.375,0.5), #50% access to home power, 75% of those L2
                       # "HA50_L2100" = c(0,0.5,0.5) #50% access to home power, all of those L2
                       )
# adding the vehicle class variable
veh_class_vec <- list("sed80_suv20" = c(0.8, 0.2), # sedan dominant
																						"sed50_suv50" = c(0.5, 0.5), # equal distribution
																						"sed20_suv80" = c(0.2, 0.8)) # suv dominant

# this would produce separate files
# sedan_suv_path <- list(c("evi_raw/",
# 																				"load_profile/"),
# 																				c("evi_raw_suv/",
# 																						"load_profile_suv/"))
```


Run the function that wraps the whole thing on each element in the list.

```{r message=FALSE}
Sys.time()
registerDoFuture() #allows foreach() to use the future package when the %dopar% operator is called
plan(multiprocess, workers = 3, gc = TRUE) #set future plan, make sure at least 1 core is reserved, call garbage collector
options(future.globals.maxSize = 10000 * 1024^2) #Set max RAM allowed for global variables to 10GB

for(i in 1:length(temp_vec)) {

  # load the raw data for sedans
  evi_data_path_sedan <- paste0("../../data/preprocessed/evi_raw/", temp_vec[i], ".rds")
  evi_raw_sedan <- readRDS(evi_data_path_sedan)
  
  # add column for vehicle class
  evi_raw_sedan[, "vehicle_class" := "Sedan"]
  
  # Repeat for SUVs
  evi_data_path_suv <- paste0("../../data/preprocessed/evi_raw_suv/", temp_vec[i], ".rds")
  evi_raw_suv <- readRDS(evi_data_path_suv)
  
  # add column for vehicle class
  evi_raw_suv[, "vehicle_class" := "SUV"]
  
  # bind together into a single data.table
  evi_raw <- rbind(evi_raw_suv,
  																	evi_raw_sedan)
  
  rm(evi_raw_suv,
  			evi_raw_sedan)
  
  # load the load profiles
  loadprof_data_path_sedan <- paste0("../../data/preprocessed/load_profile/", temp_vec[i], ".rds")
  evi_load_profiles_sedan <- readRDS(loadprof_data_path_sedan)
  
  # add vehicle class
  evi_load_profiles_sedan[, "vehicle_class" := "sedan"]
  
  # Repeat for SUVs
  loadprof_data_path_suv <- paste0("../../data/preprocessed/load_profile/", temp_vec[i], ".rds")
  evi_load_profiles_suv <- readRDS(loadprof_data_path_suv)
  
  # add vehicle class
  evi_load_profiles_suv[, "vehicle_class" := "SUV"]
  
   # bind together into a single data.table
  evi_load_profiles <- rbind(evi_load_profiles_suv,
  																											evi_load_profiles_sedan)
  
  rm(evi_load_profiles_suv,
  			evi_load_profiles_sedan)
  
  gc()
  #Parallel sessions for permutations of all other variables
  fleet_load <-
      foreach(numveh = fleet_size_vec, .combine='rbind') %do% {
        sub_fleet_load <-
          foreach(pev = names(pev_type_vec), .combine='rbind', .options.future=list(scheduling=1)) %:%
          foreach(dvmt = mean_dvmt_vec, .combine='rbind') %:%
          foreach(pref = names(pref_vec), .combine='rbind') %:%
          foreach(home = names(home_power_vec), .combine='rbind') %:%
          foreach(work = names(work_power_vec), .combine='rbind') %:%
          foreach(loc = loc_class_vec, .combine='rbind') %:%
        		foreach(vclass = names(veh_class_vec), .combine = "rbind") %dopar% {
          	
            #Generate fleet load profile for a single permutation of fleet, pev, dvmt, pref, home, work
            load_to_bind <- openEVI(evi_raw,
            																								evi_load_profiles,
            																								numveh,
                                    pev_type_vec[[pev]],
                                    dvmt,
                                    pref_vec[[pref]],
                                    home_power_vec[[home]],
                                    work_power_vec[[work]],
                                    loc,
            																								veh_class_vec[[vclass]])
       
            #Append labels to indicate variable permutations of this run
            load_to_bind[, ':='(loc_class = loc,
                                temp_c = temp_vec[i],
                                fleet_size = numveh,
                                mean_dvmt = dvmt,
                                pev_dist = pev,
                                pref_dist = pref,
                                home_access = strsplit(home,c("_"))[[1]][1],
                                home_power_dist = strsplit(home,c("_"))[[1]][2],
                                work_power_dist = work,
            																				vehcile_class_dist = vclass)]
            
            #Reduce fleet activity down to 24-hour aggregated load profile
            # Note: Remove this step, and reduce the number of variable permutations, to confirm imposed weight distributions, vehicle counts, etc.
            load_to_bind[time_of_day > 24,time_of_day := time_of_day - 24]
            load_to_bind <- load_to_bind[, .(kw = sum(avg_kw)),
                                         by = c("loc_class",
                                                "temp_c",
                                                "fleet_size",
                                                "mean_dvmt",
                                                "pev_dist",
                                                "pref_dist",
                                                "home_access",
                                                "home_power_dist",
                                                "work_power_dist",
                                                "day_of_week",
                                                "pev_type", 
                                                "dest_type", 
                                                "dest_chg_level",
                                                "time_of_day",
                                         							"vehicle_class_dist")]
            setkey(load_to_bind,
            							loc_class,temp_c,
            							fleet_size,
            							mean_dvmt,
            							pev_dist,
            							pref_dist,
            							home_access,
            							home_power_dist,
            							work_power_dist,
            							day_of_week,
            							pev_type,
            							dest_type,
            							dest_chg_level,
            							time_of_day)
            
            gc()
            
            return(load_to_bind)
        }
      }
  
  #Write fleet_load out to disk
  fwrite(fleet_load,
  										file = paste0("outputs/testing/",
  																								gsub("-", "", Sys.Date()), "_", # date the run
  																								temp_vec[i],
  																								".csv"))
  
  rm(evi_raw)
  rm(evi_load_profiles)
  rm(fleet_load)
  gc()
  
}
Sys.time()
```

Spot check the output

```{r}
check <- as.data.table(read.csv("output/EVI-Pro-Lite_Run190508_-20C.csv"))

sub_check <- check[fleet_size == 500 &
                     mean_dvmt == 50 &
                     pev_dist == "BEV100" &
                     pref_dist == "Home50" &
                     home_access == "HA50" &
                     home_power_dist == "L225",
                   .(avg_kw = sum(kw)),
                   by=c("day_of_week",
                        "pev_type",
                        "dest_type",
                        "dest_chg_level",
                        "time_of_day")]

test1 <- ggplot(data = sub_check, aes(x=time_of_day, y=avg_kw)) +
  geom_area(aes(fill=dest_chg_level)) +
  facet_grid(day_of_week + pev_type ~ dest_type)

test2 <- ggplot(sub_check[dest_type == "Public" & day_of_week == "weekend" & pev_type == "BEV250",sum(avg_kw),by=c("time_of_day","dest_chg_level")], aes(x=time_of_day, y=V1)) +
  geom_line() +
  facet_grid(~dest_chg_level)

test3 <- ggplot(sub_check[,sum(avg_kw),by=c("day_of_week","dest_chg_level","time_of_day")], aes(x=time_of_day, y=V1)) +
  geom_area(aes(fill=dest_chg_level)) +
  facet_grid(~day_of_week)
```

```{r}
# test_dt <- rbindlist(flt_list)
# test_dt[,':='(loc_class = factor(loc_class, levels = loc_class_vec),
#               temp_c = factor(temp_c, levels = temp_vec),
#               pev_dist = factor(pev_dist, levels = names(pev_type_vec)),
#               pref_dist = factor(pref_dist, levels = names(pref_vec)),
#               home_power_dist = factor(home_power_dist, levels = names(home_power_vec)),
#               work_power_dist = factor(work_power_dist, levels = names(work_power_vec)))]

prof_24_by_class <- copy(test_dt)
prof_24_by_class[time_of_day > 24,time_of_day := time_of_day - 24]
prof_24_by_class <- prof_24_by_class[, .(kw = sum(avg_kw)),
                                by = c("loc_class",
                                       "temp_c",
                                       "fleet_size",
                                       "mean_dvmt",
                                       "pev_dist",
                                       "pref_dist",
                                       "home_power_dist",
                                       "work_power_dist",
                                       "day_of_week",
                                       "pev_type", 
                                       "dest_type", 
                                       "dest_chg_level",
                                       "time_of_day")]
setkey(prof_24_by_class,loc_class,temp_c,fleet_size,mean_dvmt,pev_dist,pref_dist,home_power_dist,work_power_dist,day_of_week,pev_type,dest_type,dest_chg_level,time_of_day)
write.csv(prof_24_by_class[temp_c == "-20C",.SD], file="output/Example_load-profile-structure_-20C.csv")

```

Check out the PEV type differences between scenarios.

```{r}
test_dt[temp_c == "-10C",.(pev_type = unique(pev_type),scenario = unique(loc_class),day_of_week = unique(day_of_week)),by=c("fleet_id","pev_dist")][, .N, by = c("pev_dist","pev_type", "scenario", "day_of_week")] %>%
  ggplot(aes(pev_type, N, fill = scenario)) + 
  geom_col(position = "dodge") + 
  facet_grid(pev_dist ~ day_of_week) +
  labs(title = "Number of Vehicles by type")

test_dt[temp_c == "-10C",.(vmt = unique(schedule_vmt),scenario = unique(loc_class),day_of_week = unique(day_of_week)),by=c("fleet_id","pev_dist")][, .N, by = c("pev_dist","vmt", "scenario", "day_of_week")] %>%
  ggplot(aes(vmt)) + 
  geom_histogram(binwidth = 10) + 
  facet_wrap(pev_dist ~ day_of_week) +
  labs(title = "Number of Vehicles by type")
```

Plot the 24 hour profile in a few different configurations.

```{r}
prof_24_by_class <- copy(test_dt)
prof_24_by_class[time_of_day > 24,time_of_day := time_of_day - 24]
prof_24_by_class <- prof_24_by_class[, .(kw = sum(avg_kw)),
                                by = c("loc_class",
                                       "temp_c",
                                       "fleet_size",
                                       "mean_dvmt",
                                       "pev_dist",
                                       "pref_dist",
                                       "home_power_dist",
                                       "work_power_dist",
                                       "day_of_week",
                                       "pev_type", 
                                       "dest_type", 
                                       "dest_chg_level",
                                       "time_of_day")]

prof_24_by_class[, .(avg_kw = sum(kw)), 
                        by = c("time_of_day",
                               "dest_chg_level",
                               "day_of_week")] %>%
  ggplot(aes(x = time_of_day)) +
  geom_area(aes(y = kw, fill = dest_chg_level)) +
  scale_fill_brewer("Charger Level", palette = "Dark2") +
  labs(x = "Time of day", y = "Average kw") + 
  facet_wrap(day_of_week ~ scenario, ncol = 2)

test <- prof_24_by_class[loc_class == "urban" &
                             temp_c == "-20C" &
                             fleet_size == 500 &
                             mean_dvmt == 15 &
                             pev_dist == "PHEV" &
                             pref_dist == "Home" &
                             home_power_dist == "HA100L1" &
                             work_power_dist == "AllL2" &
                             day_of_week == "weekday" &
                             pev_type == "PHEV20" &
                             dest_type == "Home" &
                             dest_chg_level == "L1",
                         kw, by=time_of_day]

fleet_load[, .(avg_kw = sum(kw)), 
                        by = c(
                                       "home_power_dist",
                                       "pev_dist",
                                       "pref_dist",
                                       "day_of_week",
                                       "time_of_day")] %>%
ggplot(aes(x = time_of_day)) +
  geom_area(aes(y = avg_kw, fill = dest_chg_level)) +
  scale_fill_brewer("Charger Level", palette = "Dark2") +
  labs(x = "Time of day", y = "Average kw") +
  facet_grid(day_of_week + temp_c ~ pev_dist + dest_type)

fleet_load[home_power_dist == "L225", .(avg_kw = sum(kw)), 
                        by = c(
                                       "home_access",
                                       "pev_dist",
                                       "pref_dist",
                                       "dest_chg_level",
                                       "day_of_week",
                                       "time_of_day")] %>%
ggplot(aes(x = time_of_day)) +
  geom_area(aes(y = avg_kw, fill = dest_chg_level)) +
  scale_fill_brewer("Charger Level", palette = "Dark2") +
  labs(x = "Time of day", y = "Average kw") +
  facet_grid(day_of_week + home_access ~ pev_dist + pref_dist)
```

How do the ecdfs compare?

```{r}
ggplot(prof_24_by_class, aes(avg_kw_by_class, color = dest_chg_level, linetype = scenario)) +
  stat_ecdf() +
  scale_color_brewer("Charger Level", palette = "Dark2") +
  scale_linetype("Location") +
  facet_grid(day_of_week ~ dest_chg_level)
```

Output data for NREL

```{r}
nrel_dt_1_hires <- flt_list$rural$load_profile[,.(temp_c,scenario,fleet_avg_vmt,day_of_week,pev_type,dest_type,dest_chg_level,fleet_id,session_id,time_of_day,avg_kw)]
setkey(nrel_dt_1_hires,day_of_week,fleet_id,session_id,time_of_day)
write.csv(nrel_dt_1_hires,file=paste0(getwd(),"/output/SEIN-Load-Profile-Example1-HiRes.csv"))

nrel_dt_1_lowres <- nrel_dt_1_hires[,.(avg_kw = sum(avg_kw)),by=c("temp_c","scenario","fleet_avg_vmt","day_of_week","pev_type","dest_type","dest_chg_level","time_of_day")]
setkey(nrel_dt_1_lowres,time_of_day)
write.csv(nrel_dt_1_lowres,file=paste0(getwd(),"/output/SEIN-Load-Profile-Example1-LowRes.csv"))

nrel_dt_2_hires <- flt_list$urban$load_profile[,.(temp_c,scenario,fleet_avg_vmt,day_of_week,pev_type,dest_type,dest_chg_level,fleet_id,session_id,time_of_day,avg_kw)]
setkey(nrel_dt_2_hires,day_of_week,fleet_id,session_id,time_of_day)
write.csv(nrel_dt_2_hires,file=paste0(getwd(),"/output/SEIN-Load-Profile-Example2-HiRes.csv"))

nrel_dt_2_lowres <- nrel_dt_2_hires[,.(avg_kw = sum(avg_kw)),by=c("temp_c","scenario","fleet_avg_vmt","day_of_week","pev_type","dest_type","dest_chg_level","time_of_day")]
setkey(nrel_dt_2_lowres,time_of_day)
write.csv(nrel_dt_2_lowres,file=paste0(getwd(),"/output/SEIN-Load-Profile-Example2-LowRes.csv"))
```

